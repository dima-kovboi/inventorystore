<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventory Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #0f0f12;
            --bg-card: #1c1c24;
            --bg-secondary: #252530;
            --primary: #6c5ce7;
            --primary-glow: rgba(108, 92, 231, 0.4);
            --text-main: #ffffff;
            --text-muted: #8b95a5;
            --success: #00b894;
            --danger: #d63031;
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            padding-bottom: 100px;
            overflow-x: hidden;
        }

        /* --- UI COMPONENTS --- */
        .btn {
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.1s, opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn:active { transform: scale(0.96); }

        .btn-primary {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 14px;
        }

        /* --- HEADER --- */
        .header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(15, 15, 18, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .brand { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }
        .brand span { color: var(--primary); }

        .balance-container {
            background: rgba(108, 92, 231, 0.15);
            padding: 6px 6px 6px 14px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(108, 92, 231, 0.3);
        }
        
        .balance-val { font-weight: 700; color: #a29bfe; font-size: 14px; }

        /* --- MAIN MENU --- */
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 20px;
        }

        .nav-item {
            background: var(--bg-card);
            padding: 15px;
            border-radius: var(--radius);
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            transition: 0.2s;
            border: 1px solid rgba(255,255,255,0.03);
        }
        .nav-item:active { background: var(--bg-secondary); }
        .nav-item i {
            font-size: 20px;
            margin-bottom: 8px;
            display: block;
            color: var(--primary);
        }

        /* --- CATALOG --- */
        .section-title {
            padding: 0 20px;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title::before {
            content: '';
            width: 4px;
            height: 18px;
            background: var(--primary);
            border-radius: 2px;
            display: block;
        }

        .games-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 0 20px;
        }

        .game-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            height: 140px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .game-bg {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.7;
            transition: transform 0.3s;
        }
        .game-card:active .game-bg { transform: scale(1.1); opacity: 0.5; }
        
        .game-info {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px 10px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }
        .game-name { font-weight: 700; font-size: 14px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

        /* --- PRODUCT MODAL (FULL PAGE) --- */
        #product-page {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body);
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            overflow-y: auto;
        }
        #product-page.active { transform: translateX(0); }

        .page-header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            background: rgba(15,15,18,0.9);
            backdrop-filter: blur(10px);
            z-index: 10;
        }
        
        .back-btn { font-size: 20px; padding: 10px; color: var(--text-muted); cursor: pointer; }

        .items-list { padding: 20px; padding-bottom: 120px; }
        
        .item-row {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 14px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.03);
        }
        .item-row b { font-size: 15px; display: block; margin-bottom: 4px; }
        .item-price { color: var(--success); font-weight: 700; font-size: 14px; background: rgba(0, 184, 148, 0.1); padding: 4px 8px; border-radius: 6px; }

        /* --- CART BAR --- */
        .cart-overlay {
            position: fixed;
            bottom: 20px; left: 20px; right: 20px;
            background: rgba(30, 30, 40, 0.95);
            backdrop-filter: blur(15px);
            padding: 15px 20px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 300;
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .cart-overlay.show { transform: translateY(0); }

        .cart-info { font-size: 13px; color: var(--text-muted); }
        .cart-total { font-size: 18px; font-weight: 800; color: white; }
        .pay-btn { padding: 10px 24px; font-size: 14px; border-radius: 12px; }

        /* --- DEPOSIT MODAL --- */
        #modal-deposit {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 500;
            align-items: flex-end; /* Sheet style */
            animation: fadeIn 0.2s;
        }
        
        .modal-sheet {
            background: var(--bg-card);
            width: 100%;
            border-radius: 24px 24px 0 0;
            padding: 25px;
            padding-bottom: 40px;
            animation: slideUp 0.3s;
        }

        .pay-method {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .pay-method.active { border-color: var(--primary); background: rgba(108, 92, 231, 0.05); }
        .pay-title { display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .pay-details { 
            margin-top: 10px; padding-top: 10px; 
            border-top: 1px solid rgba(255,255,255,0.1); 
            font-size: 13px; color: var(--text-muted); line-height: 1.5;
            display: none; 
            word-break: break-all;
        }
        .copy-btn { font-size: 11px; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; float: right; cursor: pointer; }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        
        .loader { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: var(--bg-body); z-index: 999; 
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.5s;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(108, 92, 231, 0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- LOADER -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div style="margin-top: 20px; color: var(--text-muted); font-size: 14px;">Загрузка магазина...</div>
    </div>

    <!-- HOME PAGE -->
    <div id="home">
        <!-- Header -->
        <div class="header">
            <div class="brand">Inventory<span>Store</span></div>
            <div class="balance-container">
                <div class="balance-val" id="balance">0 ₽</div>
                <button class="btn btn-icon" onclick="openDeposit()">+</button>
            </div>
        </div>

        <!-- Menu -->
        <div class="nav-grid">
            <div class="nav-item" onclick="openLink('https://t.me/InventoryStoreReviews')">
                <i class="fas fa-star"></i>Отзывы
            </div>
            <div class="nav-item" onclick="openLink('https://t.me/dimakovboi')">
                <i class="fas fa-headset"></i>Поддержка
            </div>
            <div class="nav-item" onclick="toggleCartInfo()">
                <i class="fas fa-shopping-bag"></i>Заказы
            </div>
        </div>

        <!-- Catalog -->
        <div class="section-title">Каталог игр</div>
        <div class="games-grid">
            <div class="game-card" onclick="openGame('bs', 'Brawl Stars')">
                <img src="https://wallpapers.com/images/hd/brawl-stars-loading-screen-w9r17f7q2z3q5w1f.jpg" class="game-bg">
                <div class="game-info"><div class="game-name">Brawl Stars</div></div>
            </div>
            <div class="game-card" onclick="openGame('pubg', 'PUBG Mobile')">
                <img src="https://w0.peakpx.com/wallpaper/774/267/HD-wallpaper-pubg-mobile-game-logo.jpg" class="game-bg">
                <div class="game-info"><div class="game-name">PUBG Mobile</div></div>
            </div>
            <div class="game-card" onclick="openGame('fn', 'Fortnite')">
                <img src="https://wallpapers.com/images/hd/fortnite-llama-loot-box-3d-4k-wallpaper-p2j07d3w5x2c1x1f.jpg" class="game-bg">
                <div class="game-info"><div class="game-name">Fortnite</div></div>
            </div>
            <div class="game-card" onclick="openGame('bl', 'Blood Strike')">
                <img src="https://play-lh.googleusercontent.com/9C0d6b_wXyqQf8m6d9c6x2d9x2d9x2d9x2d9x2d9x2d9x2d9x2d9x2d9x2d9x2d9x2d9x2d9=w526-h296-rw" class="game-bg">
                <div class="game-info"><div class="game-name">Blood Strike</div></div>
            </div>
        </div>
    </div>

    <!-- PRODUCT PAGE (SLIDE OVER) -->
    <div id="product-page">
        <div class="page-header">
            <div class="back-btn" onclick="closeGame()"><i class="fas fa-arrow-left"></i></div>
            <h3 id="game-title" style="margin:0">Название игры</h3>
        </div>
        <div id="items-container" class="items-list"></div>
    </div>

    <!-- FLOATING CART -->
    <div class="cart-overlay" id="cart-bar">
        <div>
            <div class="cart-info">К оплате</div>
            <div class="cart-total" id="total-sum">0 ₽</div>
        </div>
        <button class="btn btn-primary pay-btn" onclick="pay()">
            Оплатить <i class="fas fa-chevron-right" style="margin-left:8px; font-size:12px;"></i>
        </button>
    </div>

    <!-- DEPOSIT MODAL -->
    <div id="modal-deposit" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0">Пополнить баланс</h3>
                <div style="padding:10px; cursor:pointer;" onclick="document.getElementById('modal-deposit').style.display='none'">✕</div>
            </div>

            <div class="pay-method" onclick="togglePayDetails(this)">
                <div class="pay-title"><i class="far fa-credit-card" style="color:#a29bfe"></i> Банковская карта</div>
                <div class="pay-details">
                    <span id="d-bank">Банк</span>
                    <br>
                    <b id="d-card">0000 0000 0000 0000</b>
                    <span class="copy-btn" onclick="copyText('d-card')">Коп.</span>
                    <br><br>⚠️ После перевода отправьте скриншот чека в поддержку.
                </div>
            </div>

            <div class="pay-method" onclick="togglePayDetails(this)">
                <div class="pay-title"><i class="fab fa-bitcoin" style="color:#fdcb6e"></i> Криптовалюта</div>
                <div class="pay-details">
                    USDT (TON Network)
                    <br>
                    <span id="d-crypto" style="font-size:11px; font-family:monospace;">UQ...</span>
                    <span class="copy-btn" onclick="copyText('d-crypto')">Коп.</span>
                    <br><br>⚠️ Только TON Network!
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ⚙️ НАСТРОЙКИ (ВСТАВЬ ССЫЛКУ НИЖЕ)
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycby5JLTxemN8nWZclICGpJ0TxYLUkcNqcZN8pF31-wLnkQddgZ_GtkofM5s-QHQADLon3g/exec";

        // ==========================================
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // Тестовый ID для браузера, в Телеграме возьмется настоящий
        const userId = tg.initDataUnsafe?.user?.id || 1438120200; 

        // Локальный каталог (должен совпадать с Google Script)
        const CATALOG = {
            'bs': [
                {id:"bs_30", n:"30 Гемов", p:150},
                {id:"bs_80", n:"80 Гемов", p:350},
                {id:"bs_170", n:"170 Гемов", p:650},
                {id:"bs_360", n:"360 Гемов", p:1200},
                {id:"bs_950", n:"950 Гемов", p:3000},
                {id:"bs_2000", n:"2000 Гемов", p:5500}
            ],
            'pubg': [
                {id:"pubg_60", n:"60 UC", p:90},
                {id:"pubg_325", n:"325 UC", p:450},
                {id:"pubg_660", n:"660 UC", p:850},
                {id:"pubg_1800", n:"1800 UC", p:2100}
            ],
            'fn': [
                {id:"fn_1000", n:"1000 V-Bucks", p:800},
                {id:"fn_2800", n:"2800 V-Bucks", p:1900},
                {id:"fn_5000", n:"5000 V-Bucks", p:3200}
            ],
            'bl': [
                {id:"bl_100", n:"100 Gold", p:100},
                {id:"bl_500", n:"500 Gold", p:450},
                {id:"bl_1000", n:"1000 Gold", p:850}
            ]
        };

        let cartSum = 0;

        // --- INIT ---
        async function init() {
            try {
                // Запрос к GAS
                const res = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "getUserInfo", userId: userId })
                });
                const data = await res.json();
                
                // Убираем лоадер
                document.getElementById("loader").style.opacity = '0';
                setTimeout(() => document.getElementById("loader").style.display='none', 500);

                if (data.status === "ok") {
                    // Обновляем баланс
                    animateBalance(0, data.user.balance);
                    
                    // Обновляем реквизиты
                    document.getElementById("d-bank").innerText = data.requisites.bank;
                    document.getElementById("d-card").innerText = data.requisites.card;
                    document.getElementById("d-crypto").innerText = data.requisites.crypto;
                    
                    updateCart();
                }
            } catch (e) {
                console.error(e);
                tg.showAlert("Ошибка подключения к серверу. Проверьте интернет или повторите позже.");
            }
        }

        // --- NAVIGATION & UI ---
        function openGame(key, name) {
            haptic('light');
            document.getElementById("game-title").innerText = name;
            const container = document.getElementById("items-container");
            container.innerHTML = "";
            
            CATALOG[key].forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <div>
                        <b>${item.n}</b>
                        <small style="color:#8b95a5">Моментальная доставка</small>
                    </div>
                    <div style="text-align:right">
                        <div class="item-price">${item.p} ₽</div>
                        <button class="btn btn-primary" style="margin-top:5px; padding:6px 12px; font-size:12px" onclick="addToCart('${item.id}')">
                            Купить
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });

            document.getElementById("product-page").classList.add("active");
        }

        function closeGame() {
            haptic('light');
            document.getElementById("product-page").classList.remove("active");
        }

        function openDeposit() {
            haptic('medium');
            document.getElementById("modal-deposit").style.display = "flex";
        }

        function togglePayDetails(el) {
            document.querySelectorAll('.pay-method').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.pay-details').forEach(i => i.style.display = 'none');
            
            el.classList.add('active');
            el.querySelector('.pay-details').style.display = 'block';
        }

        function openLink(url) {
            haptic('light');
            tg.openTelegramLink(url);
        }

        // --- CART LOGIC ---
        async function addToCart(code) {
            haptic('medium');
            // Анимация кнопки
            tg.MainButton.showProgress();
            
            try {
                await fetch(API_URL, { 
                    method: "POST", 
                    body: JSON.stringify({ action: "addToCart", userId: userId, itemCode: code }) 
                });
                tg.showPopup({ title: 'Успешно', message: 'Товар добавлен в корзину', buttons: [{type:'ok'}] });
                updateCart();
            } catch(e) {
                tg.showAlert("Ошибка добавления");
            }
            tg.MainButton.hideProgress();
        }

        async function updateCart() {
            const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getCart", userId: userId }) });
            const data = await res.json();
            cartSum = data.total;
            
            const cartBar = document.getElementById("cart-bar");
            if (cartSum > 0) {
                cartBar.classList.add("show");
                document.getElementById("total-sum").innerText = cartSum + " ₽";
            } else {
                cartBar.classList.remove("show");
            }
        }

        async function pay() {
            haptic('heavy');
            if(!confirm(`Списать ${cartSum} ₽ с баланса?`)) return;
            
            const btn = document.querySelector('.pay-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "payCart", userId: userId }) });
                const data = await res.json();
                
                if (data.status === "ok") {
                    tg.showPopup({ title: 'Оплачено!', message: 'Заказ передан оператору. Ожидайте.', buttons: [{type:'ok'}] });
                    location.reload();
                } else {
                    tg.showAlert("Ошибка: " + data.message);
                }
            } catch (e) {
                tg.showAlert("Ошибка соединения");
            }
            btn.innerHTML = originalText;
        }

        function toggleCartInfo() {
            if(cartSum > 0) tg.showAlert(`В корзине товаров на сумму: ${cartSum} ₽`);
            else tg.showAlert("Корзина пуста");
        }

        // --- UTILS ---
        function haptic(style) {
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred(style);
        }

        function animateBalance(start, end) {
            const el = document.getElementById("balance");
            let current = start;
            const step = Math.ceil((end - start) / 20);
            
            const timer = setInterval(() => {
                current += step;
                if(current >= end) {
                    current = end;
                    clearInterval(timer);
                }
                el.innerText = current + " ₽";
            }, 30);
        }

        function copyText(id) {
            const text = document.getElementById(id).innerText;
            navigator.clipboard.writeText(text);
            haptic('success');
            tg.showPopup({message: 'Скопировано!'});
            event.stopPropagation();
        }

        // Запуск
        init();

    </script>
</body>
</html>
